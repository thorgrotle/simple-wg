# generate wireguard host conf


# TODO 
# Set Allowed IP / Subnet
# Add colors to terminal
# Add options for delete profile/clients
# Add -c for create profile option
# Add -h for help section
# Nicer listing for existing profiles
# moving things into functions
# 
while getopts p:i:d:l:e:a:s: flag
do
    case "${flag}" in
        p) wgprofile=${OPTARG};;
        i) wgbaseinterface=${OPTARG};;
        d) wgdns=${OPTARG};;
        s) wgdns2=${OPTARG};;
        l) wglistenport=${OPTARG};;
        e) wgendpoint=${OPTARG};;
        a) wgaddress=${OPTARG};;
    esac
done


echo ""
echo "-------------------------------------"
echo "     Wireguard Server Generator"
echo "-------------------------------------"

# list profiles .ini
echo "Listing existing wireguard profiles"
ls /etc/wireguard/profiles/*.ini

# read parameter and for profile for if profile is correct, if no profile exist or input use default = wireguard.ini
if [ -z "$wgprofile" ];
	then
		read -p "Enter name of desired profile? : " wgprofile
		if [ -z "$wgprofile" ];
			then
			wgprofile=wireguard
		fi
fi

# List network interfaces for connection
echo "-------------------------------------"
echo "Listing current interfaces and IP"
echo "-------------------------------------"
ip address
echo ""


# Ask for interface
if [ -z "$wgbaseinterface" ];
	then
	read -p "Which network interface do you want to bind this wireguard instance to (default: enp6s0)?: " wgbaseinterface
	if [ -z "$wgbaseinterface" ];
		then
		wgbaseinterface=enp6s0
	fi
fi

# ask for endpoint address
if [ -z "$wgendpoint" ];
	then
	read -p "What is the IP address the clients connect to, (defeault 10.0.75.196)?: " wgendpoint
	if [ -z "$wgendpoint" ];
		then
		wgendpoint=10.0.75.196
	fi
fi

# Ask for WG network address ( default 192.168.125.1)
if [ -z "$wgaddress" ];
	then
	read -p "What is the IP address of the wireguard network, (default: 192.168.125.1)?: " wgaddress
	if [ -z "$wgaddress" ];
		then
		wgaddress=192.168.128.1
	fi
fi

# Ask for portnumber ( default 51820 )
if [ -z "$wglistenport" ];
	then
	read -p "What is the port, (default: 51820)?: " wglistenport
	if [ -z "$wglistenport" ];
		then
		wglistenport=51820
	fi
fi

# Ask for Client DNS (default 8.8.8.8)
if [ -z "$wgdns" ];
        then
        read -p "What DNS do you wish to use for the clients, (default 8.8.8.8)?: " wgdns
        if [ -z "$wgdns" ];
                then
                wgdns=8.8.8.8
        fi
fi

# Ask for Client Secondary DNS/Namesearch (default home.lan)
if [ -z "$wgdns2" ];
        then
        read -p "What secondary DNS / Namesearch do you wish to use for the clients, (default home.lan)?: " wgdns2
        if [ -z "$wgdns2" ];
                then
                wgdns2=home.lan
        fi
fi

echo "-------------------------------------"
echo "profile               (p) : " $wgprofile 
echo "Interface to mount to (i) : " $wgbaseinterface
echo "Interface port        (l) : " $wglistenport 
echo "Interface Server IP   (e) : " $wgendpoint 
echo "Wireguard Client DNS: (d) : " $wgdns 
echo "Wireguard Host IP     (a) : " $wgaddress
echo "-------------------------------------"


  # Ask if accecss to host, subnet or subnet+internet
   # If host level access, skip DNS, set allow host network address only
   # IF subnet access, skip DNS, set allow subnet network address
   # IF subnet+internet, set allow all.
    # Ask for DNS ( default 8.8.8.8 )

# Ask of input for  use of existing privatekey ( if not, create key )



	CLIENTCONFDIR=/etc/wireguard/clientconf/$wgprofile
	SERVERCONFDIR=/etc/wireguard/serverconf/$wgprofile
	WIREGUARDCPROFILE=$CLIENTCONFDIR$NEWCLIENTNAME.conf
	WIREGUARDSPROFILE=$SERVERCONFDIR$NEWCLIENTNAME.conf
	WIREGUARDPROFILE=$wgprofile.conf
	WIREKEYDIR=/etc/wireguard/keypair
	WIREGUARDINI=/etc/wireguard/profiles/$wgprofile.ini
	WGADDCLIENTS=/etc/wireguard/wgaddclients-$wgprofile

	# DEBUG + cleanup
	#wg-quick down $WIREGUARDIF
	#rm $WIREGUARDINI
	#rm $WIREGUARDPROFILE

	# creating workdirs
	mkdir -p /etc/wireguard/profiles
	mkdir -p $CLIENTCONFDIR
	mkdir -p /etc/wireguard/keypair
	mkdir -p $SERVERCONFDIR
	touch $SERVERCONFDIR/default.conf


	# Generate ini file file 
		if [ -f $WIREGUARDINI ]; 
		    then
		    echo 'Wireguard Ini file exists.'
		else
		    echo 'Creating file: '$WIREGUARDINI
			serverprivatekey=$( wg genkey | tee $WIREKEYDIR/serverkey )
			serverpubkey=$( wg pubkey < $WIREKEYDIR/serverkey | tee $WIREKEYDIR/pubserverkey )
			clientcounter=1
			echo "#Wireguard config file - generated by wg-genserver" > $WIREGUARDINI
			echo "wgprofile=$wgprofile" >> $WIREGUARDINI
			echo "serverprivatekey="$serverprivatekey >> $WIREGUARDINI
			echo "serverpubkey="$serverpubkey >> $WIREGUARDINI
			echo "wgbaseinterface=$wgbaseinterface" >> $WIREGUARDINI
			echo "wgaddress="$wgaddress >> $WIREGUARDINI
			echo "wglistenport="$wglistenport >> $WIREGUARDINI
			echo "wgendpoint="$wgendpoint >> $WIREGUARDINI
			echo "wgdns="$wgdns >> $WIREGUARDINI
			echo "wgdns2="$wgdns2 >> $WIREGUARDINI
			echo "CLIENTCONFDIR="$CLIENTCONFDIR >> $WIREGUARDINI
			echo "SERVERCONFDIR="$SERVERCONFDIR >> $WIREGUARDINI
			echo "clientcounter=1" >> $WIREGUARDINI
			rm $WIREKEYDIR/*
			
		fi

	# generate main wireguard config file
	source $WIREGUARDINI
		if [ -f $WIREGUARDPROFILE ]; then
		    echo 'Wireguard config file exists.'
		else
			echo 'Creating file: '$WIREGUARDPROFILE
			echo "#Wireguard profile file - generated by wg-genserver" > $WIREGUARDPROFILE
			echo "[Interface]" >> $WIREGUARDPROFILE
			echo "Address = "$wgaddress >> $WIREGUARDPROFILE
			echo "ListenPort = "$wglistenport >> $WIREGUARDPROFILE
			echo "PrivateKey = "$serverprivatekey >> $WIREGUARDPROFILE
			echo "PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o "$wgbaseinterface" -j MASQUERADE && $WGADDCLIENTS" >> $WIREGUARDPROFILE
			echo "PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o "$wgbaseinterface" -j MASQUERADE" >> $WIREGUARDPROFILE

		fi

	# generate main wireguard addclients file
		if [ -f $WGADDCLIENTS ]; then
		    echo "Wireguard file $WGADDCLIENTS already exists"
		else
			echo "Creating file: " $WGADDCLIENTS
			echo "#!/usr/bin/bash" > $WGADDCLIENTS
			echo "#Wireguard script to start add client file to $wgprofile - generated by wg-genserver" >> $WGADDCLIENTS
			echo "source $WIREGUARDINI" >> $WGADDCLIENTS
			echo "for filename in $SERVERCONFDIR/*.conf; do" >> $WGADDCLIENTS
			echo 'echo $filename' >> $WGADDCLIENTS
			echo 'wg addconf $wgprofile  $filename' >> $WGADDCLIENTS
			echo 'done' >> $WGADDCLIENTS
			chmod +x $WGADDCLIENTS

		fi
