# generate wireguard host conf

# Getting variables from flags
while getopts p:c: flag
do
    case "${flag}" in
        p) wgprofile=${OPTARG};;
        c) NEWCLIENTNAME=${OPTARG};;
    esac
done

# Reading if profile has been set, else ask user for profile
if [ -z "$wgprofile" ];
	then
	ls /etc/wireguard/profiles/*.ini
	read -p "Input desired profile name to add client to?: " wgprofile
fi


# Reading environment variables	from ini file
WIREGUARDINI=/etc/wireguard/profiles/$wgprofile.ini
. $WIREGUARDINI

# Generate ini file file 
	if [ -f $WIREGUARDINI ]; 
		then
		echo "Wireguard profile " $WIREGUARDINI" file exists, fetching settings"
		source $WIREGUARDINI

	else
		echo 'No profile: '$WIREGUARDINI ' exist, please select correct profile or run wg-genserver to create profile'
		exit
	fi


# creates new ip address from Server IP address and counter from wireguard.ini
ClientCounterNew=$(($clientcounter+1))
ClientAddress=$( echo $wgaddress | sed 's![^.]*$!!')$(($ClientCounterNew))


if [ -z "$NEWCLIENTNAME" ];
	then
	read -p "Input name for new wireguard client?: " NEWCLIENTNAME
	if [ -z "$NEWCLIENTNAME" ];
		then
		NEWCLIENTNAME=Client$ClientCounterNew
	fi
fi

# Setting profile destination path
WIREGUARDSPROFILE=$SERVERCONFDIR/$NEWCLIENTNAME.conf
WIREGUARDCPROFILE=$CLIENTCONFDIR/$NEWCLIENTNAME.conf



# Generate Client key
                clientprivatekey=$( wg genkey | tee $WIREKEYDIR/clientkey )
                clientpubkey=$( wg pubkey < $WIREKEYDIR/clientkey | tee $WIREKEYDIR/pubclientkey )


# generate wireguard server client file
        if [ -f $WIREGUARDSPROFILE ]; then
            echo 'Wireguard config file exists.'
        else
                echo 'Creating file: '$WIREGUARDSPROFILE
                echo "#Wireguard profile file - generated by wg-genclient" > $WIREGUARDSPROFILE
                echo "[Peer]" >> $WIREGUARDSPROFILE
                echo "PublicKey = "$clientpubkey >> $WIREGUARDSPROFILE
                echo "AllowedIPs = "$ClientAddress/32 >> $WIREGUARDSPROFILE

        fi
# Generate client conf file
        if [ -f $WIREGUARDCPROFILE ]; then
            echo 'Wireguard client file exists.'
        else
                echo 'Creating file: '$WIREGUARDCPROFILE

                echo "#Wireguard client profile $NEWCLIENTNAME.conf on $wgprofile - generated by wg-genclient" > $WIREGUARDCPROFILE
                echo "[Interface]" >> $WIREGUARDCPROFILE
                echo "PrivateKey = "$clientprivatekey >> $WIREGUARDCPROFILE
                echo "Address = "$ClientAddress/24 >> $WIREGUARDCPROFILE
                echo "DNS = "$wgdns", $wgdns2, " >> $WIREGUARDCPROFILE
		echo "" >> $WIREGUARDCPROFILE
                echo "[Peer]" >> $WIREGUARDCPROFILE
                echo "PublicKey = "$serverpubkey >> $WIREGUARDCPROFILE
                echo "AllowedIPs = 0.0.0.0/0" >> $WIREGUARDCPROFILE
                echo "Endpoint = "$wgendpoint:$wglistenport >> $WIREGUARDCPROFILE
		echo ""
			sed -i '/^clientcou*/ d' $WIREGUARDINI
			echo "clientcounter="$ClientCounterNew >> $WIREGUARDINI
	fi

#echo ""
#echo "----------------------------------------------------------------"
#cat $WIREGUARDCPROFILE
echo "----------------------------------------------------------------"
qrencode -t ansiutf8 < $WIREGUARDCPROFILE
echo "--------------------COPY AND PASTE BELOW------------------------"
cat $WIREGUARDCPROFILE
echo ""
echo "----------------------------------------------------------------"


